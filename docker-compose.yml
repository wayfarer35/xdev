version: "3.8"

services:
  nginx:
    image: nginx:stable
    container_name: xdev_nginx
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ${PROJECT_DIR:-./src}:/var/www/html:delegated
      - ./logs/nginx:/var/log/nginx
      - ./data/nginx:/var/cache/nginx
    depends_on:
      - php
    networks:
      - webnet

  php:
    image: "${PHP_IMAGE}"
    container_name: xdev_php
    env_file: ./.php-8.4.env
    ports:
      - "${PHP_FPM_PORT:-9000}:9000"
    volumes:
      - ${PROJECT_DIR:-./src}:/var/www/html:delegated
      - ./config/php/8.4/php.ini:/usr/local/etc/php/php.ini:ro
      - ./config/php/8.4/www.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ./logs/php/8.4:/var/log/php
      - ./images/php/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./data/php/8.4:/var/lib/php
      - ./config/php/extensions.allowed:/opt/php-extensions-available/extensions.allowed:ro
    networks:
      - webnet

  mysql:
    image: mysql:8.0
    container_name: xdev_mysql
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-rootpass}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-app_db}"
      MYSQL_USER: "${MYSQL_USER:-app}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-apppass}"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mysql:/etc/mysql/conf.d:ro
      - ./logs/mysql:/var/log/mysql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - webnet

  redis:
    image: redis:7
    container_name: xdev_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - ./data/redis:/data
      - ./logs/redis:/var/log/redis
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    networks:
      - webnet

networks:
  webnet:
    driver: bridge